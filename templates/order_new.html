{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="row between">
    <div class="h3">Novo pedido</div>
    <a class="link" href="/orders">Voltar</a>
  </div>

  <div class="muted" style="margin-top:6px;">
    Digite <b>SKU</b> ou <b>nome do produto</b>. O preço é automático.
  </div>

  <form method="post" action="/orders/new" style="margin-top:10px;">
    <label class="label">Cliente (opcional)</label>
    <input class="input" name="customer_name" list="customers_list" placeholder="Digite ou selecione">
    <datalist id="customers_list">
      {% for c in customers %}
      <option value="{{ c.name }}"></option>
      {% endfor %}
    </datalist>

    <div style="height:12px;"></div>

    <div class="h3">Itens</div>
    <div id="items"></div>

    <div class="card" style="margin-top:12px;">
      <div class="row between" style="align-items:center;">
        <div class="h3" style="margin:0;">Resumo</div>
        <div class="muted">Atualiza automaticamente</div>
      </div>
      <div class="grid two" style="margin-top:10px;">
        <div class="kv"><div class="k">Itens</div><div class="v"><b id="sum_items">0</b></div></div>
        <div class="kv"><div class="k">Total</div><div class="v"><b id="sum_total">R$ 0,00</b></div></div>
      </div>
    </div>


    <div class="row gap" style="margin-top:10px;">
      <button class="btn" type="button" onclick="addRow()">+ Adicionar item</button>
      <button class="btn primary" type="submit">Salvar pedido</button>
    </div>
  </form>
</div>

<datalist id="plist">
  {% for p in products %}
    {% if p.sku %}
      <option value="{{ p.sku }}" label="{{ p.name }} — R$ {{ '%.2f'|format(p.price) }}"></option>
    {% endif %}
    <option value="{{ p.name }}" label="{% if p.sku %}SKU {{ p.sku }} — {% endif %}R$ {{ '%.2f'|format(p.price) }}"></option>
  {% endfor %}
</datalist>

<script>
const products = [
  {% for p in products %}
  { id: {{p.id}}, name: "{{ p.name|replace('"','') }}", sku: "{{ (p.sku or '')|replace('"','') }}", price: {{ '%.2f'|format(p.price) }} },
  {% endfor %}
];

function norm(s){ return (s||"").trim().toLowerCase(); }
function findProduct(input){
  const v = norm(input);
  if(!v) return null;
  return products.find(p => norm(p.sku) === v) || products.find(p => norm(p.name) === v) || null;
}

function suggestMatches(query){
  const v = norm(query);
  if(!v || v.length < 3) return [];
  const bySku = products.filter(p => norm(p.sku).startsWith(v)).slice(0, 6);
  const byName = products.filter(p => norm(p.name).includes(v) && !bySku.includes(p)).slice(0, 6);
  return [...bySku, ...byName].slice(0, 8);
}

function renderSuggest(box, items){
  if(!box) return;
  if(!items || !items.length){ box.classList.remove("show"); box.innerHTML = ""; return; }
  box.classList.add("show");
  box.innerHTML = items.map(p => {
    const sku = (p.sku && p.sku.trim()) ? `SKU ${p.sku}` : "Sem SKU";
    const price = moneyBR(p.price);
    return `<button type="button" data-pid="${p.id}">
      <div class="left">
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="meta">${escapeHtml(sku)}</div>
      </div>
      <div class="price">${price}</div>
    </button>`;
  }).join("");
}

function escapeHtml(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

function isLastRow(row){
  const rows = Array.from(document.querySelectorAll(".item-row"));
  return rows.length && rows[rows.length-1] === row;
}

function rowIsFilled(row){
  const pid = row.querySelector(".prod-id")?.value;
  const qty = Number(row.querySelector(".qty")?.value || 0);
  return !!pid && qty > 0;
}

function ensureTrailingEmptyRow(){
  const rows = Array.from(document.querySelectorAll(".item-row"));
  if(!rows.length) return;
  const last = rows[rows.length-1];
  if(rowIsFilled(last)) addRow(true);
}



function removeRow(btn){ btn.closest('.item-row').remove(); recalcTotals(); }

function moneyBR(v){
  const n = Number(v||0);
  return "R$ " + n.toFixed(2).replace(".", ",");
}

function recalcTotals(){
  const rows = Array.from(document.querySelectorAll(".item-row"));
  let total = 0;
  let count = 0;
  for(const r of rows){
    const pid = r.querySelector(".prod-id")?.value;
    const qty = Number(r.querySelector(".qty")?.value || 0);
    if(pid && qty > 0){
      count += 1;
      const p = products.find(x => String(x.id) === String(pid));
      const sub = (p ? Number(p.price) : 0) * qty;
      total += sub;
      const subText = r.querySelector(".sub-text");
      if(subText) subText.textContent = moneyBR(sub);
    }else{
      const subText = r.querySelector(".sub-text");
      if(subText) subText.textContent = "—";
    }
  }
  document.getElementById("sum_items").textContent = String(count);
  document.getElementById("sum_total").textContent = moneyBR(total);
}


function rowTemplate(){
  return `
  <div class="row gap item-row" style="align-items:flex-end;">
    <div style="flex:2;" class="suggest-wrap">
      <label class="label">Produto (Nome ou SKU)</label>
      <input class="input prod-input" list="plist" placeholder="Ex: COCA2L ou Coca-Cola 2L" autocomplete="off">
      <div class="suggest"></div>
      <input type="hidden" name="product_ids" class="prod-id" value="">
    </div>

    <div style="flex:1;">
      <label class="label">Qtd</label>
      <input class="input qty" name="qtys" type="number" step="1" min="1" value="1">
    </div>

    <div style="flex:1;">
      <label class="label">Preço</label>
      <div class="input" style="display:flex;align-items:center;justify-content:space-between;">
        <span class="price-text muted">—</span>
      </div>
    </div>

    <div style="flex:1;">
      <label class="label">Subtotal</label>
      <div class="input" style="display:flex;align-items:center;justify-content:space-between;">
        <span class="sub-text muted">—</span>
      </div>
    </div>

    <div>
      <label class="label">&nbsp;</label>
      <button class="btn" type="button" onclick="removeRow(this)">Remover</button>
    </div>
  </div>`;
}

function wireRow(row){
  const input = row.querySelector(".prod-input");
  const hid = row.querySelector(".prod-id");
  const priceText = row.querySelector(".price-text");
  const suggestBox = row.querySelector(".suggest");
  const qty = row.querySelector(".qty");

  function apply(){
    const p = findProduct(input.value);
    if(!p){
      hid.value = "";
      priceText.textContent = "—";
      recalcTotals();
      return;
    }
    hid.value = String(p.id);
    // keep what user typed, but normalize to SKU if it matches exactly
    if(norm(input.value) === norm(p.name) && p.sku){ /* keep name */ }
    priceText.textContent = moneyBR(p.price);
    recalcTotals();
  }

  function refreshSuggest(){
    const matches = suggestMatches(input.value);
    renderSuggest(suggestBox, matches);
  }

  input.addEventListener("input", function(){
    refreshSuggest();
    apply();
  });

  input.addEventListener("focus", refreshSuggest);

  input.addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      e.preventDefault();
      apply();
      // if last row and filled, add another
      if(isLastRow(row) && rowIsFilled(row)){
        addRow(true);
      }
      // focus qty if empty, else next product
      if(!qty.value || Number(qty.value) < 1){
        qty.focus();
      }else{
        const rows = Array.from(document.querySelectorAll(".item-row"));
        const idx = rows.indexOf(row);
        const next = rows[idx+1];
        if(next) next.querySelector(".prod-input")?.focus();
      }
    }
  });

  qty.addEventListener("input", function(){
    recalcTotals();
    if(isLastRow(row) && rowIsFilled(row)) ensureTrailingEmptyRow();
  });

  // click select
  suggestBox?.addEventListener("mousedown", function(e){
    const btn = e.target.closest("button[data-pid]");
    if(!btn) return;
    e.preventDefault();
    const pid = btn.getAttribute("data-pid");
    const p = products.find(x => String(x.id) === String(pid));
    if(!p) return;
    input.value = (p.sku && p.sku.trim()) ? p.sku : p.name;
    hid.value = String(p.id);
    priceText.textContent = moneyBR(p.price);
    renderSuggest(suggestBox, []);
    recalcTotals();
    qty.focus();
    ensureTrailingEmptyRow();
  });

  // close suggestions on outside click
  document.addEventListener("click", function(ev){
    if(!row.contains(ev.target)){
      renderSuggest(suggestBox, []);
    }
  });
}

function addRow(autoFocus=false){
  const wrap = document.getElementById("items");
  wrap.insertAdjacentHTML("beforeend", rowTemplate());
  const row = wrap.lastElementChild;
  wireRow(row);
  if(autoFocus){
    row.querySelector(".prod-input")?.focus();
  }
  recalcTotals();
}

addRow(true); addRow(); ensureTrailingEmptyRow(); recalcTotals();

document.querySelector("form").addEventListener("submit", function(e){
  const rows = Array.from(document.querySelectorAll(".item-row"));
  for(const r of rows){
    const input = r.querySelector(".prod-input");
    const pid = r.querySelector(".prod-id").value;
    const qty = Number(r.querySelector(".qty").value || 0);
    // ignore completely empty rows
    if(!input.value && !pid) continue;
    if(!pid){
      e.preventDefault();
      alert("Selecione um produto válido (nome ou SKU) em todos os itens.");
      input.focus();
      return;
    }
    if(qty <= 0){
      e.preventDefault();
      alert("Quantidade inválida.");
      r.querySelector(".qty").focus();
      return;
    }
  }
});

</script>

{% endblock %}
