<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or ((branding.product_name ~ " - Sistema") if branding else "IMPÉRIO - Sistema") }}</title>
  <link rel="stylesheet" href="/static/app.css">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="apple-touch-icon" href="/static/favicon.png">
  {% if branding %}
  <style>
    :root{
      --pri: {{ branding.primary_color }};
      --pri2: {{ branding.secondary_color }};
    }
  </style>
  {% endif %}

<style>
:root{
  --primary: {{ (branding.primary_color if branding else '#2f6bff') }};
  --secondary: {{ (branding.secondary_color if branding else '#9a7bff') }};
  --bg: {{ (branding.bg_color if branding else '#0b0f14') }};
  {% if branding and branding.theme_mode == 'light' %}
  --txt: #0f172a;
  --mut: rgba(15, 23, 42, .70);
  --card: rgba(255,255,255,.88);
  --line: rgba(15, 23, 42, .12);
  {% else %}
  --txt: #ecf0ff;
  --mut: rgba(236, 240, 255, .70);
  --card: rgba(15, 18, 58, .75);
  --line: rgba(255,255,255,.10);
  {% endif %}
}
body{ background: var(--bg) !important; color: var(--txt) !important; }
</style>

</head>
<body>
<div class="toast-container" id="toast_container">
  {% set ok = request.query_params.get('ok') %}
  {% set err = request.query_params.get('err') %}
  {% if ok %}
    <div class="toast success" data-autohide="1">
      <div class="toast-title">Tudo certo</div>
      <div class="toast-msg">
        {% if ok == 'venda_salva' %}Venda salva com sucesso.{% elif ok == 'pedido_salvo' %}Pedido salvo com sucesso.{% else %}Operação concluída.{% endif %}
      </div>
    </div>
  {% endif %}
  {% if err %}
    <div class="toast error" data-autohide="0">
      <div class="toast-title">Atenção</div>
      <div class="toast-msg">{{ err }}</div>
    </div>
  {% endif %}
</div>

<script>
(function(){
  const tc = document.getElementById('toast_container');
  if(!tc) return;
  const toasts = tc.querySelectorAll('.toast[data-autohide="1"]');
  toasts.forEach(t => setTimeout(()=>{ t.classList.add('hide'); setTimeout(()=>t.remove(), 250); }, 2800));
})();
</script>


{% if user %}
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo" style="
  {% set _logo = None %}
  {% if branding and branding.logo_url and features.get('white_label') %}
    {% set _logo = branding.logo_url %}
  {% endif %}
  {% if not _logo %}
    {% set _logo = '/static/img/imperio.png' %}
  {% endif %}
  background-image: url('{{ _logo }}');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
"></div>
        <div>
          <div class="brand-title">{{ (branding.product_name if branding else "IMPÉRIO") }}</div>
          <div class="brand-sub">{{ user.store_name }}</div>
          <div class="badge-row">
            <span class="badge">{{ (segment or "deposito")|upper }}</span>
            <span class="badge outline">{{ (plan or "basic")|upper }}</span>
          </div>
        </div>
      </div>

      <nav class="nav">
        {% if features.core_dashboard %}<a href="/dashboard">Dashboard</a>{% endif %}
        {% if features.segment_orders %}<a href="/orders">Pedidos</a>{% endif %}
        {% if features.segment_tables %}<a href="/tabs">Comandas</a>{% endif %}
        {% if features.core_sales %}<a href="/sales">Vendas</a>{% endif %}
        {% if features.core_products %}<a href="/products">Produtos</a>{% endif %}
        {% if features.core_customers %}<a href="/customers">Clientes</a>{% endif %}
        {% if user.role == "admin" and features.get("theme_custom") %}<a href="/personalizacao">Personalização</a>{% endif %}
        <a href="/billing">Assinatura</a>
      </nav>

      <div class="sidebar-footer">
        <div class="muted">Logado como <b>{{ user.username }}</b> <span class="muted">({{ user.role }})</span></div>
        <a class="link" href="/logout">Sair</a>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="topbar-left">
          <button class="icon-btn" id="toggleMenu" aria-label="Menu">☰</button>
          <div>
            <div class="kicker">{{ kicker or "" }}</div>
            <div class="page-title">{{ page_title or "" }}</div>
          </div>
        </div>
        <div class="actions">
          {% if features.core_sales %}<a class="btn" href="/sales/new">+ Nova venda</a>{% endif %}
          {% if features.segment_orders %}<a class="btn primary" href="/orders/new">+ Novo pedido</a>{% endif %}
        </div>
      </div>

      {% if error %}
        <div class="alert error">{{ error }}</div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    (function(){
      const btn = document.getElementById("toggleMenu");
      const sb = document.getElementById("sidebar");
      if(!btn || !sb) return;
      btn.addEventListener("click", function(){
        sb.classList.toggle("hidden");
      });
    })();
  </script>

{% else %}
  <div class="public-wrap">
    <div class="public-card">
      {% if error %}
        <div class="alert error">{{ error }}</div>
      {% endif %}
      {% block public %}{% endblock %}
    </div>
  </div>
{% endif %}

</body>
</html>